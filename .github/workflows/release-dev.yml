name: Release Dev

on:
  push:
    branches:
      - dev
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-dev-${{ github.ref }}
  cancel-in-progress: false

jobs:
  prepare:
    name: Prepare dev release
    runs-on: ubuntu-latest
    outputs:
      release_tag: ${{ steps.meta.outputs.release_tag }}
      release_name: ${{ steps.meta.outputs.release_name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Validate updater signing credentials (preflight)
        shell: bash
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          if [[ -z "$TAURI_SIGNING_PRIVATE_KEY" ]]; then
            echo "Missing TAURI_SIGNING_PRIVATE_KEY secret."
            exit 1
          fi

          if [[ -z "$TAURI_SIGNING_PRIVATE_KEY_PASSWORD" ]]; then
            echo "Missing TAURI_SIGNING_PRIVATE_KEY_PASSWORD secret."
            exit 1
          fi

          CHECK_FILE="$(mktemp)"
          printf 'openusage-signing-preflight\n' > "$CHECK_FILE"

          npm --workspace @openusage-mono/tauri-src run tauri -- signer sign --private-key "$TAURI_SIGNING_PRIVATE_KEY" --password "$TAURI_SIGNING_PRIVATE_KEY_PASSWORD" "$CHECK_FILE" >/dev/null

          rm -f "$CHECK_FILE" "$CHECK_FILE.sig"

      - name: Typecheck workspace
        run: bun run check-types

      - name: Build website
        run: bun run --cwd apps/web build

      - name: Validate version alignment
        shell: bash
        run: |
          TAURI_CONF_VERSION=$(node -p 'require("./packages/tauri-src/src-tauri/tauri.conf.json").version')
          CARGO_VERSION=$(awk -F'"' '/^version =/ { print $2; exit }' ./packages/tauri-src/src-tauri/Cargo.toml)
          PKG_VERSION=$(node -p 'require("./packages/tauri-src/package.json").version')

          if [[ "$TAURI_CONF_VERSION" != "$CARGO_VERSION" ]]; then
            echo "src-tauri/tauri.conf.json version ($TAURI_CONF_VERSION) != Cargo.toml version ($CARGO_VERSION)"
            exit 1
          fi

          if [[ "$TAURI_CONF_VERSION" != "$PKG_VERSION" ]]; then
            echo "src-tauri/tauri.conf.json version ($TAURI_CONF_VERSION) != packages/tauri-src/package.json version ($PKG_VERSION)"
            exit 1
          fi

      - name: Compute dev release metadata
        id: meta
        shell: bash
        run: |
          APP_VERSION=$(node -p 'require("./packages/tauri-src/src-tauri/tauri.conf.json").version')
          SHORT_SHA=$(echo "$GITHUB_SHA" | cut -c1-7)
          DATE_UTC=$(date -u +%Y%m%d)
          RELEASE_TAG="dev-v${APP_VERSION}-${DATE_UTC}-${SHORT_SHA}"
          RELEASE_NAME="Dev ${APP_VERSION} (${SHORT_SHA})"

          echo "release_tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"
          echo "release_name=$RELEASE_NAME" >> "$GITHUB_OUTPUT"

  publish:
    name: Publish dev binaries (${{ matrix.target }})
    needs: prepare
    runs-on: ${{ matrix.platform }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            args: --target aarch64-apple-darwin
          - platform: macos-latest
            target: x86_64-apple-darwin
            args: --target x86_64-apple-darwin
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            args: --target x86_64-pc-windows-msvc
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@v1
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./packages/tauri-src/src-tauri -> target"

      - name: Validate updater signing key
        shell: bash
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
        run: |
          if [[ -z "$TAURI_SIGNING_PRIVATE_KEY" ]]; then
            echo "Missing TAURI_SIGNING_PRIVATE_KEY secret."
            exit 1
          fi

      - name: Publish dev release asset
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          projectPath: packages/tauri-src
          tagName: ${{ needs.prepare.outputs.release_tag }}
          releaseName: ${{ needs.prepare.outputs.release_name }}
          releaseDraft: false
          prerelease: true
          includeUpdaterJson: true
          args: ${{ matrix.args }}
